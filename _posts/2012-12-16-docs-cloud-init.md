---
layout: article
title: Cloud-Init Contextualization
category: review
---

Contextualization allows a virtual machine instance to learn about its
cloud environment (the 'context') and to configure itself to run
correctly there.  StratusLab now supports CloudInit contextualization
in addition to the OpenNebula and HEPiX contextualization schemes.

This article explains how an appliance using CloudInit can be created
and how users can send contextualization information to the
appliance. 

CloudInit
---------

The [CloudInit][ci-docs] mechanism is gaining traction within the
cloud ecosystem and is moving towards becoming a de facto standard for
the process.  Because it handles both web-server and disk based
contextualization mechanisms it is fairly straightforward for cloud
software developers to implement.

For the appliance developers it provides a convenient modular
framework for allowing both system and user-level service
configuration.  Being written in python with OS packages for most
systems, makes it easy for those developers to include and use the
software.

Ubuntu provides [good documentation][ci-docs] for CloudInit.  The
software itself can be downloaded from [launchpad][ci-code] or
installed from standard repositories for your operating system
(e.g. [EPEL][epel] for CentOS).


Building an Image Using CloudInit
---------------------------------

The standard StratusLab commands for creating appliances
(e.g. `stratus-create-image`) can be used to create an appliance using
CloudInit.  See the image creation document for details on the
commands.

The script that was fed to `stratus-create-image` for the example
appliance used below is: 

    #!/bin/bash -x 

    #
    # Turn off udev caching of network information.
    #
    rm -f /lib/udev/rules.d/*net-gen*
    rm -f /etc/udev/rules.d/*net.rules

    #
    # Add 'user' account and allow access to root via sudo.
    #
    adduser user
    chmod u+w /etc/sudoers
    cat >> /etc/sudoers <<EOF
    user ALL=(ALL) NOPASSWD: ALL
    EOF
    chmod u-w /etc/sudoers

    #
    # Configure the machine for the EPEL repository.  The CloudInit
    # package is available from there.
    #
    wget -nd http://fr2.rpmfind.net/linux/epel/6/i386/epel-release-6-7.noarch.rpm
    yum install -y epel-release-6-7.noarch.rpm

    #
    # Upgrade all package on the machine and install cloud-init.
    yum clean all 
    yum upgrade -y 
    yum install -y cloud-init

    #
    # Change configuration to allow root access.  Signal that the 'user'
    # account should also be configured.
    #
    sed -i 's/user: ec2-user/user: user/' /etc/cloud/cloud.cfg
    sed -i 's/disable_root: 1/disable_root: 0/' /etc/cloud/cloud.cfg

This script was named `create-cloud-init-appliance.sh` for the command
to create the machine:

    $ stratus-create-image \
        -s create-cloud-init-appliance.sh \
        --type c1.medium \
        --title 'example title' \
        --comment 'example comment' \
        --author 'Jane Creator' \
        --author-email 'jane@example.org' \
        Jd3yRF6x4ofxfCeVK6BmCkuHc0m 

The image ID Jd3yRF6x4ofxfCeVK6BmCkuHc0m refers to a standard CentOS
6.2 machine.  The configuration commands and the package to be
installed will depend on what base operating system you choose.

A registered public appliance created with this script has the
identifier "KaErHffeHiomQt-nDwawbigogWY".  This is used in the web
server example that follows.


Web Server Example
------------------

To show how users can pass CloudInit information to the appliance, we
will work through an example with the generated image.  We will use a
script to install and configure a web server on the example machine.
This script is generated by the user, sent via the
`stratus-run-instance` command and then executed in the machine
instance by the CloudInit contextualization.

The script that we want to execute on the machine instance is the
following: 

    #!/bin/bash -x

    yum install -y httpd 

    cat > /var/www/html/test.txt <<EOF
    SUCCESSFUL TEST
    EOF

    chkconfig httpd on 

    service httpd start

This installs, configures, and starts a web server on the machine.
We've named this script `run-http.sh`.  Create this script on the
machine where you've installed the StratusLab client commands. 

The context information must be prepared before starting the machine
instance.  To do this use the command `stratus-prepare-context`.  This
takes a list of arguments where each argument is a mime-type and file
name separated by commas.  For ssh keys, use the pseudo-mime-type of
'ssh'. For example, 

    $ stratus-prepare-context \
         ssh,$HOME/.ssh/id_rsa.pub \
         x-shellscript,run-http.sh

Multiple public ssh keys can be provided.  Multiple scripts or other
types of contextualization files can be provided.  See the [CloudInit
documentation][ci-docs] for what is permitted for 'user data'.

*Warning*: Be sure that the contextualization information you are
passing can be used by the CloudInit version within the appliance
itself.

This command creates a context file `cloud-init.txt` with the
requested information that can be used with the `stratus-run-instance`
command.  It will look like:

    CONTEXT_METHOD=cloud-init
    CLOUD_INIT_AUTHORIZED_KEYS=c3NoLXJzYS...
    CLOUD_INIT_USER_DATA=H4sIAGHZzV...

The last two parameters contain base64 encoded representations of the
ssh keys and the `run-http.sh` script.

The machine can then be started with the command:

    $ stratus-run-instance \
        --context-file cloud-init.txt \
        KaErHffeHiomQt-nDwawbigogWY

The `--context-file` option passes the CloudInit contextualization
information to the virtual machine instance through the cloud
interface.

After this machine starts it should be possible to see the configured
file in the appliance's web server: 

    $ curl http://vm.example.org/test.txt 
    SUCCESSFUL TEST

Of course you need to change the node name to point to the machine
instance that you've started. 


Conclusions
-----------

StratusLab support for CloudInit should make it easier for users to
create appliances that will run on StratusLab as well as on other
clouds using an implementation compatible with CloudInit.  This will
be an important gain for users as they move to a federated cloud
environment. 

This preview support for CloudInit demonstrates the utility of this
contextualization method.  The collaboration is interested in hearing
your feedback on the implementation so that we can improve it in
upcoming releases. 


[ci-docs]: https://help.ubuntu.com/community/CloudInit
[ci-code]: https://launchpad.net/cloud-init
[epel]: http://fedoraproject.org/wiki/EPEL
