<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
<head>
  <title>  StratusLab :: Create a Base Image  </title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="Author" content="Marcin Mierzejewski @ Zenzire"/>
  <meta name="Keywords" content="StratusLab,Create a Base Image"/>
  <meta name="Description" content="StratusLabCreate a Base Image"/>
  <meta name="generator" content="DokuWiki" />
<meta name="robots" content="index,follow" />
<meta name="date" content="2012-04-25T15:28:50+0200" />
<meta name="keywords" content="tutorial,createbaseimage" />
<link rel="search" type="application/opensearchdescription+xml" href="../lib/exe/opensearch.php" title="StratusLab" />
<link rel="start" href="../index.html" />
<link rel="contents" href="./tutorial:createbaseimage.html?do=index" title="Sitemap" />
<link rel="canonical" href="./tutorial:createbaseimage.html" />
<link rel="stylesheet" media="screen" type="text/css" href="../lib/exe/css.php?t=stratuslab-theme&amp;tseed=1349958590" />
<link rel="stylesheet" media="all" type="text/css" href="../lib/exe/css.php?s=all&amp;t=stratuslab-theme&amp;tseed=1349958590" />
<link rel="stylesheet" media="print" type="text/css" href="../lib/exe/css.php?s=print&amp;t=stratuslab-theme&amp;tseed=1349958590" />
<script type="text/javascript" ><!--//--><![CDATA[//><!--
var NS='tutorial';var JSINFO = {"id":"tutorial:createbaseimage","namespace":"tutorial"};
//--><!]]></script>
<script type="text/javascript" charset="utf-8" src="../lib/exe/js.php?tseed=1349958590" ></script>
  <link rel="alternate" type="application/rss+xml" title="News"
     href="../feed.php?ns=news.html&amp;linkto=page" />

  <link rel="stylesheet" media="screen" type="text/css" href="../lib/tpl/stratuslab-theme/css/design.css" />
  <link rel="stylesheet" media="screen" type="text/css" href="../lib/tpl/stratuslab-theme/css/gallery.css" />
  <link rel="stylesheet" type="text/css" href="../lib/tpl/stratuslab-theme/css/960.css" media="screen" />

  <script type="text/javascript">

   var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-18570821-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
 })();

</script>
</head>

<body>
  <div class="Page">
		<div class="Header">

			<div class="Banner">
			      </div>

			<div class="MenuContainer"><div class="Menu" id="level1">
<p>

<!-- main menu under the banner -->
<div class="mainmenu">
<span class="menuitem">
<a class="menulink" href="../index.php">Home</a>
</span>
<span class="menuitem">
<a class="menulink" href="./release:install.html">Install</a>
</span>
<span class="menuitem">
<a class="menulink" href="support.html">Support</a>
</span>
<span class="menuitem">
<a class="menulink" href="documentation.html">Documentation</a>
</span>
<span class="menuitem">
<a class="menulink" href="./roadmap:project_roadmap.html">Roadmap</a>
</span>
<span class="menuitem">
<a class="menulink" href="news.html">News</a>
</span>
<span class="menuitem">
<a class="menulink" href="./project:info.html">About</a>
</span>
</div>


</p>
</div><div class="Menu" id="level2"></div>
		</div> 


    	
		<div class="Content">
				<!-- TOC START -->
<div class="toc">
<div class="tocheader toctoggle" id="toc__header">Table of Contents</div>
<div id="toc__inside">

<ul class="toc">
<li class="level1"><div class="li"><span class="li"><a href="./tutorial:createbaseimage.html#create_a_base_image" class="toc">Create a Base Image</a></span></div>
<ul class="toc">
<li class="level2"><div class="li"><span class="li"><a href="./tutorial:createbaseimage.html#prerequisities" class="toc">Prerequisities</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="./tutorial:createbaseimage.html#download_distribution_and_configuration_script" class="toc">Download Distribution and Configuration Script</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="./tutorial:createbaseimage.html#start_the_installation.html" class="toc">Start the Installation</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="./tutorial:createbaseimage.html#initialize_the_disk_image" class="toc">Initialize the Disk Image</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="./tutorial:createbaseimage.html#install_ttylinux" class="toc">Install ttylinux</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="./tutorial:createbaseimage.html#changing_configuration_of_installed_system" class="toc">Changing Configuration of Installed System</a></span></div>
<ul class="toc">
<li class="level3"><div class="li"><span class="li"><a href="./tutorial:createbaseimage.html#remove_user_account" class="toc">Remove &quot;user&quot; Account</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="./tutorial:createbaseimage.html#randomize_root_password" class="toc">Randomize Root Password</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="./tutorial:createbaseimage.html#networking_configuration" class="toc">Networking Configuration</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="./tutorial:createbaseimage.html#firewall_configuration" class="toc">Firewall Configuration</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="./tutorial:createbaseimage.html#ssh_daemon_configuration" class="toc">SSH Daemon Configuration</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="./tutorial:createbaseimage.html#contextualization_support.html" class="toc">Contextualization Support</a></span></div></li>
</ul>
</li>
<li class="level2"><div class="li"><span class="li"><a href="./tutorial:createbaseimage.html#finishing_the_installation.html" class="toc">Finishing the Installation</a></span></div></li></ul>
</li></ul>
</div>
</div>
<!-- TOC END -->

<h1 class="sectionedit1"><a name="create_a_base_image" id="create_a_base_image">Create a Base Image</a></h1>
<div class="level1">

<p>

To understand the basic procedure involved in creating a base image, this section goes through the process of recreating the ttylinux 9.x images used throughout the tutorial.
</p>

</div>

<h2 class="sectionedit2"><a name="prerequisities" id="prerequisities">Prerequisities</a></h2>
<div class="level2">

<p>

This procedure uses libvirt to create the base image.  You will need to be logged into a machine running libvirt over kvm and have the correct permissions to launch and control virtual machines via libvirt.  Although all of the configuration can be done through the console, it is usually more convenient to log in remotely via ssh.  This requires that the networking and DHCP are correctly setup on the machine. 

</p>

</div>

<h2 class="sectionedit3"><a name="download_distribution_and_configuration_script" id="download_distribution_and_configuration_script">Download Distribution and Configuration Script</a></h2>
<div class="level2">

<p>

You can obtain the <a href="http://minimalinux.org/ttylinux/downloadX86.html" class="urlextern" title="http://minimalinux.org/ttylinux/downloadX86.html"  rel="nofollow">CDROM distribution</a> of ttylinux from the <a href="http://minimalinux.org/ttylinux/" class="urlextern" title="http://minimalinux.org/ttylinux/"  rel="nofollow">ttylinux website</a>. <em>Be sure to download the latest <strong>i486, 9.x version</strong>; the other variants do not appear to include the rtl8139 driver used by default with KVM/QEMU.</em>
</p>

<p>
You can also download the <a href="./wiki:tutorial:ttylinux-script.html" class="wikilink1" title="wiki:tutorial:ttylinux-script">configuration script</a> that can be run remotely to execute all of the steps in this section of the tutorial.  The configuration can also be done by hand though the console.  The rest of this section explains the configuration, step-by-step. 
</p>

</div>

<h2 class="sectionedit4"><a name="start_the_installation" id="start_the_installation">Start the Installation</a></h2>
<div class="level2">

<p>

First create a file that will eventually contain the base ttylinux image.  The libvirt tools can create a file automatically, but it is preferable to do it manually as this provides more control.

</p>
<pre class="code">name=ttylinux-i486-9.7
rm -f ${name}.img
dd if=/dev/zero of=${name}.img bs=1024 count=32000</pre>

<p>

Here we use the names ttylinux-i486-9.7.*, but you can change this.  (Use a version consistent with the version number of ttylinux.)  These commands create a 32MB file, providing enough space for the OS (~10 MB) and space for expansion and tests. 
</p>

<p>
Next, launch the installation with libvirt.  This initializes a new virtual machine and should pop up the console.  (Ensure that you have X11 running on the machine and that you have accessed the machine via <code>ssh -Y root@machine.example.org</code>.)

</p>
<pre class="code">virt-install --connect=qemu:///system \
             --name=ttylinux \
             --noreboot \
             --ram=256 \
             --disk path=${name}.img \
             --vcpus=1 \
             --hvm \
             --accelerate \
             --cdrom=${name}.iso \
             --network=bridge:br0 \
             --mac=0a:0a:86:9e:49:f0</pre>

<p>

Be sure to use a mac address that is associated with a public IP address in your DHCP server, if you intend to do the machine configuration remotely. 
</p>

<p>
This will boot you into a ttylinux system that can be used to create another ttylinux installation. 
</p>

</div>

<h2 class="sectionedit5"><a name="initialize_the_disk_image" id="initialize_the_disk_image">Initialize the Disk Image</a></h2>
<div class="level2">

<p>

The disk image must be partitioned and formatted before the ttylinux system can be installed on it.  The ttylinux system contains all of the tools necessary to do this.
</p>

<p>
First, create a single primary partition on the disk:

</p>
<pre class="code">fdisk /dev/hda &lt;&lt;EOF
n
p
1


w
EOF</pre>

<p>

The commands in order: 1) create a new partition (n), 2) choose a primary partition (p), 3) number the partition 1 (1, a number), 4) two blank lines that choose defaults (first and last blocks), and 5) write the partition table to disk (w).
</p>

<p>
Afterwards, create an ext2 file system on the disk.

</p>
<pre class="code">mkfs.ext2 /dev/hda1</pre>

<p>

<em>Do not use an ext3 filesystem because the default boot loader (lilo) cannot handle that.</em>

</p>

</div>

<h2 class="sectionedit6"><a name="install_ttylinux" id="install_ttylinux">Install ttylinux</a></h2>
<div class="level2">

<p>

The installation of ttylinux on the prepared filesystem is essentially a copy of the system running off of the CDROM image.  The distribution provides a command to do this copy and install the boot loader.

</p>
<pre class="code">ttylinux-installer -m /dev/hdc /dev/hda1 &lt;&lt;EOF
yes
yes
EOF</pre>

<p>

Note that the first argument of the command is a full device (the CDROM), while the second is a disk partition. 

</p>

</div>

<h2 class="sectionedit7"><a name="changing_configuration_of_installed_system" id="changing_configuration_of_installed_system">Changing Configuration of Installed System</a></h2>
<div class="level2">

<p>

Most of the remaining work is just changing the configuration of the newly installed system.  To access the file, mount the new file system.

</p>
<pre class="code">mount /dev/hda1 /mnt</pre>

<p>

<em>Ensure that all of the following changes are made to the new filesystem under /mnt!</em>

</p>

</div>

<h3 class="sectionedit8"><a name="remove_user_account" id="remove_user_account">Remove &quot;user&quot; Account</a></h3>
<div class="level3">

<p>

The configuration by default will have two accounts enabled: root and user.  Remove the user account to minimize the access to the final system.

</p>
<pre class="code"># Remove the account &quot;user&quot; on the generated system.
chroot /mnt /bin/deluser user </pre>

</div>

<h3 class="sectionedit9"><a name="randomize_root_password" id="randomize_root_password">Randomize Root Password</a></h3>
<div class="level3">

<p>

It is important that shared images do not contain known passwords.  To ensure that someone cannot log into the machine via a password, the root password is randomized on startup with the following script:

</p>
<pre class="code">#!/bin/sh
newpswd=\`cat /dev/urandom | tr -dc &quot;a-zA-Z0-9-_\$\?&quot; | head -c 8\`
passwd root &lt;&lt;EOF
$newpswd
$newpswd
EOF</pre>

<p>

This should be placed in the <code>/mnt/etc/rc.d/rc.startup/08.rndm-pswd</code> file.  Logins with a password via SSH will also be turned off below.
</p>

<p>
Make sure this script is executable. 

</p>
<pre class="code">chmod 0755 /mnt/etc/rc.d/rc.startup/08.rndm-pswd</pre>

</div>

<h3 class="sectionedit10"><a name="networking_configuration" id="networking_configuration">Networking Configuration</a></h3>
<div class="level3">

<p>

The StratusLab distribution assumes that basic networking will be handled via DHCP.  It also will also currently setup two network interfaces, one for a public network and one for a private one.  Starting up the network is just a matter of enabling the interfaces.  The following two parameters should be set to “yes”:

</p>
<pre class="code">enabled=yes
dhcp=yes</pre>

<p>

in the files <code>/mnt/etc/sysconfig/network-scripts/ifcfg-eth0</code> and <code>ifcfg-eth1</code>.

</p>

</div>

<h3 class="sectionedit11"><a name="firewall_configuration" id="firewall_configuration">Firewall Configuration</a></h3>
<div class="level3">

<p>

By default, ttylinux uses firewall settings that restrict inbound access to ftp, http, and ssh for TCP and to ports 69 and port above 1024 for UDP.  Outbound access is not filtered.
</p>

<p>
For our configuration, we will further restrict the access to only the ssh port on TCP, but allow ping requests. To restrict the open ports, edit the <code>/mnt/etc/firewall.conf</code> file.  Comment out all ports except the ssh one (22).  
</p>

<p>
Recent versions of the ttylinux distribution also allow ICMP (ping) traffic by default.  No additional configuration is needed.

</p>

</div>

<h3 class="sectionedit12"><a name="ssh_daemon_configuration" id="ssh_daemon_configuration">SSH Daemon Configuration</a></h3>
<div class="level3">

<p>

As the virtual machine will be running remotely, it will be necessary to access it via ssh.  However, allowing password access would potentially allow others to interfere with our running instance.  Instead we will require access only via public and private keys (which will be installed as part of the contextualization process). 
</p>

<p>
Add the following line to the <code>/mnt/etc/sysconfig/ssh</code> file:

</p>
<pre class="code">SSHD_OPTIONS=&quot;-m - s -g&quot;</pre>

<p>

The “m” option turns off the message of the day (not required); the “s” turns off password authentication for SSH for regular users; “g” is for the root user. 

</p>

</div>

<h3 class="sectionedit13"><a name="contextualization_support" id="contextualization_support">Contextualization Support</a></h3>
<div class="level3">

<p>

Often information about the virtual machine&#039;s execution environment is necessary to have a working service.  This contextualization often involves setting up networking or passing credentials to services.  For StratusLab, the basic networking is setup via DHCP.  However, SSH credentials need to be passed to the instance to make it accessible.  Such information is passed through a CDROM image. 
</p>

<p>
Put the following into the <code>/mnt/usr/bin/onecontext</code> file:

</p>
<pre class="file">#!/bin/sh -e

[ -e /dev/hdd ] &amp;&amp; DEVICE=hdd || DEVICE=sr0

CONTEXT_DIR=/mnt/stratuslab
mkdir -p $CONTEXT_DIR

mount -t iso9660 /dev/$DEVICE $CONTEXT_DIR

if [ -f $CONTEXT_DIR/context.sh ]; then
  $CONTEXT_DIR/init.sh
fi</pre>

<p>

This mounts the CDROM image if available and runs the given initialization script.  You must make sure this script is executable. 

</p>
<pre class="code">$ chmod 0755 /mnt/usr/bin/onecontext</pre>

<p>
To systematically run this at the end of the boot sequence, a initialization script is added to the configured machine:

</p>
<pre class="code">#!/bin/sh
/usr/bin/onecontext</pre>

<p>

This should be put into the file <code>/mnt/etc/rc.d/rc.startup/95.context</code>. As usual, ensure this is executable:

</p>
<pre class="code">chmod 0755 /mnt/etc/rc.d/rc.startup/95.context</pre>

</div>

<h2 class="sectionedit14"><a name="finishing_the_installation" id="finishing_the_installation">Finishing the Installation</a></h2>
<div class="level2">

<p>

Unmount the installed file system and <em>power off</em> the machine:

</p>
<pre class="code">umount /mnt
shutdown -h</pre>

<p>

The libvirt installation will detect when the machine is powered off.  It will stop and leave you with the prepared machine image.  
</p>

<p>
If you halt the machine rather than power it off, then the installation process must be interrupted with ctrl-c.  The created image however, contains a complete working system.  This can be tested using the standard mechanisms for launching a virtual machine shown above. 

</p>

</div>

		</div>
  
    
        <div class="stylefoot">
      <div class="meta">
        <div class="doc">
	  <!--
          tutorial/createbaseimage.txt &middot; Last modified: 2012/04/25 15:28 by airaj	  -->
        </div>
        <div class="user">
                  </div>
      </div>
          </div>
    
<div class="container_12" id="footer">

<div class="clear">&nbsp;</div>
<div class="footspacer">&nbsp;</div>


<div class="grid_2 push_10 omega">
<a class="footerlink" href="mailto:info@stratuslab.eu">General queries</a><br>
<a class="footerlink" href="mailto:support@stratuslab.eu">Support queries</a>
<div class="clear">&nbsp;</div>
<div class="spacer">&nbsp;</div>
<a class="footerlink" href="internal.html">Go to project internal pages</a> 
</div>

<div class="clear">&nbsp;</div>
<div class="spacer">&nbsp;</div>




<div class="clear">&nbsp;</div>
<div class="spacer">&nbsp;</div>


<div class="grid_1 push_2 alpha">
<div class="partnerlink">
<a class="imagelink" href="./project:cnrs.html"><img src="../lib/tpl/stratuslab-theme/images/partnerlogos/cnrs-logo.png"></a></a>
<a class="partnerlink" href="./project:cnrs.html">CNRS</a>
</div>
</div>
<div class="grid_1 push_2">
<div class="partnerlink">
<a class="imagelink" href="./project:grnet.html"><img src="../lib/tpl/stratuslab-theme/images/partnerlogos/grnet-logo.png"></a><br>
<a class="partnerlink" href="./project:grnet.html">GRNET</a>
</div>
</div>
<div class="grid_1 push_2">
<div class="partnerlink">
<a class="imagelink" href="./project:sixsq.html"><img src="../lib/tpl/stratuslab-theme/images/partnerlogos/sixsq-logo.png"></a><br>
<a class="partnerlink" href="./project:sixsq.html">SixSq Sàrl</a>
</div>
</div>
<div class="grid_1 push_2">
<div class="partnerlink">
<a class="imagelink" href="./project:ucm.html"><img src="../lib/tpl/stratuslab-theme/images/partnerlogos/ucm-logo.png"></a><br>
<a class="partnerlink" href="./project:ucm.html">UCM</a>
</div>
</div>
<div class="grid_1 push_2">
<div class="partnerlink">
<a class="imagelink" href="./project:tid.html"><img src="../lib/tpl/stratuslab-theme/images/partnerlogos/tid-logo.png"></a><br>
<a class="partnerlink" href="./project:tid.html">TID</a>
</div>
</div>
<div class="grid_1 push_2">
<div class="partnerlink">
<a class="imagelink" href="./project:tcd.html"><img src="../lib/tpl/stratuslab-theme/images/partnerlogos/tcd-logo.png"></a><br>
<a class="partnerlink" href="./project:tcd.html">TCD</a>
</div>
</div>
<div class="grid_1 push_4 omega">
<img src="../lib/tpl/stratuslab-theme/images/FP7-cap-CMYK.png">
</div>
<div class="grid_1 push_4">
<img src="../lib/tpl/stratuslab-theme/images/eu-flag-blue-yellow.png">
</div>
<!-- <div class="grid_2 push_3 omega">
<img src="images/e-infrastructure-logo.png">
</div> -->

<div class="spacer">&nbsp;</div>
<div class="grid_10 push_2">
The StratusLab project is co-funded by the European Community's Seventh Framework Programme (Capacities) Grant Agreement INFSO-RI-261552.
</div>
<div class="clear">&nbsp;</div>
<div class="spacer">&nbsp;</div>


</div> <!-- end container_12 div -->

	    </div>
</body>
</html>
